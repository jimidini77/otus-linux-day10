# otus-linux-day10
Bash, grep, awk, sed и т.д.

# **Prerequisite**
- Host OS: Windows 10.0.19043
- Guest OS: CentOS 7.8.2003
- VirtualBox: 6.1.34
- Vagrant: 2.2.19

# **Содержание ДЗ**

* Написать скрипт для крона, который раз в час присылает на заданную почту:
* X IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
* Y запрашиваемых адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
* Все ошибки c момента последнего запуска;
* Список всех кодов возврата с указанием их кол-ва с момента последнего запуска;
* В письме должно быть прописан обрабатываемый временной диапазон;
* Должна быть реализована защита от мультизапуска.

# **Выполнение**

### Создание скрипта

В секции с переменными в частности задаются параметры запуска скрипта

```
#VARIABLES_BEGIN
MAIL_ADDR=jimi77.gk@gmail.com # адрес, на который шлётся отчёт
LOGPATH=/var/log/access.log # анализируемый лог
TOP_IP=10 # количество source IP
TOP_RESOURCE=10 # количество ресурсов
#VARIABLES_END
```

Защита от мультизапуска реализована созданием при старте контрольного файла и удалением его при корректном завершении скрипта:
```
if [[ -f $RUN_FLAG ]]; # если создан флаг, скрипт уже запущен или некорректно завершён
    then echo "!!! SCRIPT ALWAYS RUNNING OR UNSUCCESSFULY COMPLITED !!! If you're sure, delete the file /tmp/watchdog.run and run again."; exit 1;
fi
touch $RUN_FLAG # создание флага запущенного скрипта
```

Используется bash trap для удаления контрольного файла при при нормальном завершении, 
при получении прерывающего сигнала, который может быть обработан (не сработает, если:
скрипт был убит сигналом SIGKILL, OOM-killer убил скрипт, машина внезапно выключилась/потеряла питание):
```
function finish {
    rm -f "$RUN_FLAG";
    exit 0;
}
trap finish EXIT 
```

В конце работы скрипта сохраняется последняя проанализированная строка для использования при следующих запусках:
```
LOCKPATH=/tmp/watchdog.lock
...
tail -n 1 $LOGPATH > $LOCKPATH;
```

Для отправки e-mail используется `mailx` с почтового ящика на Yandex

# **Результаты**

Полученный в ходе работы `Vagrantfile` с включенным inline shell provisioner и созданный скрипт `checker.sh` помещены в публичный репозиторий.
При запуске ВМ скрипт помещается в `/etc/cron.hourly/`, анализируемый лог - в `/var/log/`

- **GitHub** - https://github.com/jimidini77/otus-linux-day10
